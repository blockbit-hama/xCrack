# üè¶ Liquidation Flow ÏãúÌÄÄÏä§ Îã§Ïù¥Ïñ¥Í∑∏Îû®

> **DeFi Ï≤≠ÏÇ∞ Ï†ÑÎûµÏùò Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§Î≥Ñ ÏÉÅÏÑ∏ ÏãúÌÄÄÏä§ Îã§Ïù¥Ïñ¥Í∑∏Îû®**
>
> Í∞Å Ïª¥Ìè¨ÎÑåÌä∏ÏôÄ Ïô∏Î∂Ä ÏÑúÎπÑÏä§ Í∞ÑÏùò ÏÉÅÌò∏ÏûëÏö©ÏùÑ Îã®Í≥ÑÎ≥ÑÎ°ú ÏãúÍ∞ÅÌôî

---

## üìã Î™©Ï∞®

1. [Ï†ÑÏ≤¥ Ï≤≠ÏÇ∞ ÌîÑÎ°úÏÑ∏Ïä§](#-Ï†ÑÏ≤¥-Ï≤≠ÏÇ∞-ÌîÑÎ°úÏÑ∏Ïä§)
2. [Aave v3 Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ ÌîåÎ°úÏö∞](#-aave-v3-Ï≤≠ÏÇ∞-ÏÉÅÏÑ∏-ÌîåÎ°úÏö∞)
3. [Compound v3 Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ ÌîåÎ°úÏö∞](#-compound-v3-Ï≤≠ÏÇ∞-ÏÉÅÏÑ∏-ÌîåÎ°úÏö∞)
4. [MakerDAO Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ ÌîåÎ°úÏö∞](#-makerdao-Ï≤≠ÏÇ∞-ÏÉÅÏÑ∏-ÌîåÎ°úÏö∞)
5. [MEV Î≤àÎì§ ÏÉùÏÑ± Î∞è Ï†úÏ∂ú ÌîåÎ°úÏö∞](#-mev-Î≤àÎì§-ÏÉùÏÑ±-Î∞è-Ï†úÏ∂ú-ÌîåÎ°úÏö∞)
6. [ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú vs ÌçºÎ∏îÎ¶≠ Ìè¥Î∞± ÌîåÎ°úÏö∞](#-ÌîÑÎùºÏù¥Îπó-Ï†úÏ∂ú-vs-ÌçºÎ∏îÎ¶≠-Ìè¥Î∞±-ÌîåÎ°úÏö∞)
7. [Flashloan Ï≤≠ÏÇ∞ Ïã§Ìñâ ÌîåÎ°úÏö∞](#-flashloan-Ï≤≠ÏÇ∞-Ïã§Ìñâ-ÌîåÎ°úÏö∞)
8. [DEX Aggregator Ïä§Ïôë ÌîåÎ°úÏö∞](#-dex-aggregator-Ïä§Ïôë-ÌîåÎ°úÏö∞)
9. [Í≤ΩÏüÅ Î∂ÑÏÑù Î∞è Í∞ÄÏä§ ÏµúÏ†ÅÌôî ÌîåÎ°úÏö∞](#-Í≤ΩÏüÅ-Î∂ÑÏÑù-Î∞è-Í∞ÄÏä§-ÏµúÏ†ÅÌôî-ÌîåÎ°úÏö∞)
10. [ÏóêÎü¨ Ï≤òÎ¶¨ Î∞è Î≥µÍµ¨ ÌîåÎ°úÏö∞](#-ÏóêÎü¨-Ï≤òÎ¶¨-Î∞è-Î≥µÍµ¨-ÌîåÎ°úÏö∞)

---

## üîÑ Ï†ÑÏ≤¥ Ï≤≠ÏÇ∞ ÌîÑÎ°úÏÑ∏Ïä§

### 1Ô∏è‚É£ ÌÜµÌï© Ï≤≠ÏÇ∞ Í¥ÄÎ¶¨Ïûê Ïã§Ìñâ ÌîåÎ°úÏö∞

```mermaid
sequenceDiagram
    participant User as ÏÇ¨Ïö©Ïûê/Î¥á
    participant ILM as IntegratedLiquidationManager
    participant MPS as MultiProtocolScanner
    participant LSV2 as LiquidationStrategyV2
    participant PC as ProfitabilityCalculator
    participant LBB as LiquidationBundleBuilder
    participant LEE as LiquidationExecutionEngine
    participant FB as FlashbotsClient
    participant BC as Blockchain

    User->>ILM: start_automated_liquidation()
    activate ILM

    ILM->>MPS: start_background_scanning()
    activate MPS
    MPS-->>ILM: OK
    deactivate MPS

    loop Î©îÏù∏ Ïã§Ìñâ Î£®ÌîÑ (30Ï¥àÎßàÎã§)
        ILM->>ILM: detect_and_analyze_opportunities()

        ILM->>LSV2: detect_opportunities()
        activate LSV2

        LSV2->>MPS: scan_all_protocols()
        activate MPS
        MPS->>BC: get_user_account_data()
        activate BC
        BC-->>MPS: account_data
        deactivate BC
        MPS-->>LSV2: liquidatable_users[]
        deactivate MPS

        loop Í∞Å Ï≤≠ÏÇ∞ ÎåÄÏÉÅ ÏÇ¨Ïö©Ïûê
            LSV2->>PC: analyze_liquidation_profitability()
            activate PC
            PC->>BC: get_current_gas_price()
            activate BC
            BC-->>PC: (base_fee, priority_fee)
            deactivate BC
            PC-->>LSV2: profitability_analysis
            deactivate PC

            alt ÏàòÏùµÏÑ± ÏûàÏùå
                LSV2->>LSV2: calculate_success_probability()
            end
        end

        LSV2-->>ILM: opportunities[]
        deactivate LSV2

        alt Í∏∞Ìöå Î∞úÍ≤¨
            ILM->>LBB: build_liquidation_bundle(scenario)
            activate LBB
            LBB->>LBB: analyze_competition_level()
            LBB->>LBB: calculate_success_probability()
            LBB->>LBB: create_mev_bundle()
            LBB-->>ILM: liquidation_bundle
            deactivate LBB

            ILM->>LEE: execute_liquidation_bundle(bundle)
            activate LEE
            LEE->>LEE: simulate_bundle()

            alt ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏÑ±Í≥µ
                LEE->>FB: submit_bundle()
                activate FB
                FB->>BC: send to Flashbots relay
                activate BC
                BC-->>FB: bundle_hash
                deactivate BC
                FB-->>LEE: bundle_hash
                deactivate FB

                loop ÏµúÎåÄ 20Î∏îÎ°ù ÎåÄÍ∏∞
                    LEE->>BC: check_bundle_status()
                    activate BC
                    BC-->>LEE: status
                    deactivate BC

                    alt Î≤àÎì§ Ìè¨Ìï®Îê®
                        LEE->>LEE: update_execution_stats()
                        LEE-->>ILM: SubmissionResult{success=true}
                    end
                end
            else ÏãúÎÆ¨Î†àÏù¥ÏÖò Ïã§Ìå®
                LEE-->>ILM: SubmissionResult{success=false}
            end
            deactivate LEE

            ILM->>ILM: process_execution_results()
        end

        ILM->>ILM: update_performance_metrics()
        ILM->>ILM: cleanup_expired_data()
    end

    User->>ILM: stop_automated_liquidation()
    ILM->>MPS: stop_background_scanning()
    ILM-->>User: final_stats
    deactivate ILM
```

---

## üè¶ Aave v3 Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ ÌîåÎ°úÏö∞

### 2Ô∏è‚É£ Aave v3 Ï≤≠ÏÇ∞ Í∏∞Ìöå ÌÉêÏßÄ Î∞è Î∂ÑÏÑù

```mermaid
sequenceDiagram
    participant MPS as MultiProtocolScanner
    participant Aave as Aave LendingPool
    participant User as User Account
    participant PC as ProfitabilityCalculator
    participant DEX as DEX Aggregator (0x/1inch)
    participant Oracle as Price Oracle

    MPS->>Aave: scan_aave_positions(protocol)
    activate MPS

    loop Í∞Å Í≥†ÏúÑÌóò ÏÇ¨Ïö©Ïûê
        MPS->>Aave: get_user_account_data(user)
        activate Aave
        Aave->>User: read collateral & debt
        activate User
        User-->>Aave: (total_collateral, total_debt, health_factor)
        deactivate User
        Aave-->>MPS: UserAccountData
        deactivate Aave

        MPS->>MPS: health_factor = account_data.health_factor / 1e18

        alt health_factor < 1.0 (Ï≤≠ÏÇ∞ Í∞ÄÎä•)
            MPS->>MPS: find_best_liquidation_pair()

            MPS->>PC: calculate_liquidation_profit()
            activate PC

            PC->>Oracle: get_asset_price(collateral_asset)
            activate Oracle
            Oracle-->>PC: collateral_price_usd
            deactivate Oracle

            PC->>Oracle: get_asset_price(debt_asset)
            activate Oracle
            Oracle-->>PC: debt_price_usd
            deactivate Oracle

            PC->>DEX: get_swap_quote(collateral‚Üídebt)
            activate DEX
            DEX-->>PC: SwapQuote{price_impact, expected_output}
            deactivate DEX

            PC->>PC: gross_profit = liquidation_amount √ó 0.05 (5% Î≥¥ÎÑàÏä§)
            PC->>PC: gas_cost = 800k √ó gas_price
            PC->>PC: slippage = price_impact √ó collateral_value
            PC->>PC: flashloan_fee = debt_amount √ó 0.0009
            PC->>PC: net_profit = gross_profit - gas_cost - slippage - flashloan_fee

            PC-->>MPS: ProfitabilityAnalysis{net_profit_usd}
            deactivate PC

            alt net_profit > min_threshold
                MPS->>MPS: create_liquidation_opportunity()
                Note right of MPS: LiquidationOpportunity<br/>Ï∂îÍ∞Ä
            end
        end
    end

    MPS-->>MPS: sort by net_profit (DESC)
    deactivate MPS
```

### 3Ô∏è‚É£ Aave v3 Ï≤≠ÏÇ∞ Ïã§Ìñâ (Flashloan Î™®Îìú)

```mermaid
sequenceDiagram
    participant LEE as LiquidationExecutionEngine
    participant Aave as Aave LendingPool
    participant Flashloan as Aave FlashLoan
    participant DEX as DEX Aggregator
    participant User as User Account
    participant BC as Blockchain

    LEE->>LEE: execute_liquidation_bundle(bundle)
    activate LEE

    LEE->>Aave: liquidationCall(collateral, debt, user, amount, false)
    activate Aave

    Note over Aave,Flashloan: Flashloan Ï≤≠ÏÇ∞ Ïã§Ìñâ
    Aave->>Flashloan: flashLoanSimple(receiver, asset, amount, params, 0)
    activate Flashloan

    Flashloan->>LEE: executeOperation(asset, amount, premium, initiator, params)
    activate LEE

    Note over LEE: 1. Ï≤≠ÏÇ∞ Ïã§Ìñâ
    LEE->>Aave: liquidationCall(collateral, debt, user, amount, false)
    Aave->>User: transfer collateral to liquidator
    activate User
    User-->>Aave: collateral transferred
    deactivate User
    Aave-->>LEE: liquidation successful

    Note over LEE: 2. Îã¥Î≥¥ ÌåêÎß§
    LEE->>DEX: swap(collateral, debt, collateral_amount)
    activate DEX
    DEX-->>LEE: debt_tokens_received
    deactivate DEX

    Note over LEE: 3. Flashloan ÏÉÅÌôò
    LEE->>Flashloan: repay(amount + premium)
    Flashloan-->>LEE: repayment successful
    deactivate LEE

    Flashloan-->>Aave: flashloan completed
    deactivate Flashloan

    Aave-->>LEE: liquidation completed
    deactivate Aave

    LEE->>BC: transfer profit to owner
    activate BC
    BC-->>LEE: profit transferred
    deactivate BC

    LEE-->>LEE: update_execution_stats()
    deactivate LEE
```

---

## üèõÔ∏è Compound v3 Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ ÌîåÎ°úÏö∞

### 4Ô∏è‚É£ Compound v3 Ï≤≠ÏÇ∞ Í∏∞Ìöå ÌÉêÏßÄ

```mermaid
sequenceDiagram
    participant MPS as MultiProtocolScanner
    participant Comet as Compound Comet
    participant User as User Account
    participant PC as ProfitabilityCalculator

    MPS->>Comet: scan_compound_positions(protocol)
    activate MPS

    loop Í∞Å Í≥†ÏúÑÌóò ÏÇ¨Ïö©Ïûê
        MPS->>Comet: borrow_balance_of(user)
        activate Comet
        Comet->>User: read normalized debt
        activate User
        User-->>Comet: borrow_base
        deactivate User
        Comet-->>MPS: borrow_base (Í∏∞Ï¥àÏûêÏÇ∞ Î∂ÄÏ±Ñ)
        deactivate Comet

        alt borrow_base > 0
            MPS->>MPS: liquidation_amount = min(borrow_base, max_size)

            Note right of MPS: ÏµúÏ†Å Îã¥Î≥¥ ÏûêÏÇ∞ ÏÑ†ÌÉù
            loop Í∞Å ÏßÄÏõê Îã¥Î≥¥ ÏûêÏÇ∞
                MPS->>Comet: quote_collateral(asset, liquidation_amount)
                activate Comet
                Comet-->>MPS: collateral_amount
                deactivate Comet

                MPS->>MPS: ÏµúÎåÄ Îã¥Î≥¥ ÏàòÎ†πÎüâ ÎπÑÍµê
            end

            MPS->>MPS: best_collateral = max(collateral_amounts)

            MPS->>PC: calculate_liquidation_profit()
            activate PC
            PC->>PC: gross_profit = liquidation_amount √ó 0.075 (7.5% Î≥¥ÎÑàÏä§)
            PC->>PC: gas_cost = 800k √ó gas_price
            PC->>PC: net_profit = gross_profit - gas_cost
            PC-->>MPS: ProfitabilityAnalysis
            deactivate PC

            alt net_profit > min_threshold
                MPS->>MPS: create_compound_opportunity()
            end
        end
    end

    MPS-->>MPS: opportunities[]
    deactivate MPS
```

### 5Ô∏è‚É£ Compound v3 Ï≤≠ÏÇ∞ Ïã§Ìñâ

```mermaid
sequenceDiagram
    participant LEE as LiquidationExecutionEngine
    participant Comet as Compound Comet
    participant User as User Account
    participant DEX as DEX Aggregator
    participant BC as Blockchain

    LEE->>LEE: execute_compound_liquidation(opportunity)
    activate LEE

    LEE->>Comet: liquidate(user, asset, amount, collateral_asset)
    activate Comet

    Comet->>User: transfer collateral to liquidator
    activate User
    User-->>Comet: collateral transferred
    deactivate User

    Comet->>User: reduce borrow balance
    activate User
    User-->>Comet: borrow balance reduced
    deactivate User

    Comet-->>LEE: liquidation successful
    deactivate Comet

    LEE->>DEX: swap(collateral, base_asset, collateral_amount)
    activate DEX
    DEX-->>LEE: base_tokens_received
    deactivate DEX

    LEE->>BC: transfer profit to owner
    activate BC
    BC-->>LEE: profit transferred
    deactivate BC

    LEE-->>LEE: update_execution_stats()
    deactivate LEE
```

---

## üè∞ MakerDAO Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ ÌîåÎ°úÏö∞

### 6Ô∏è‚É£ MakerDAO Ï≤≠ÏÇ∞ Í∏∞Ìöå ÌÉêÏßÄ

```mermaid
sequenceDiagram
    participant MPS as MultiProtocolScanner
    participant Vat as MakerDAO Vat
    participant User as User Vault (Urn)
    participant PC as ProfitabilityCalculator

    MPS->>Vat: scan_maker_positions(protocol)
    activate MPS

    loop Í∞Å Í≥†ÏúÑÌóò ÏÇ¨Ïö©Ïûê
        loop Í∞Å ilk (ETH-A, ETH-B, WBTC-A)
            MPS->>Vat: urns(ilk, user)
            activate Vat
            Vat->>User: read vault state
            activate User
            User-->>Vat: (ink, art) // Îã¥Î≥¥, Ï†ïÍ∑úÌôî Î∂ÄÏ±Ñ
            deactivate User
            Vat-->>MPS: (ink, art)
            deactivate Vat

            alt art > 0 (Î∂ÄÏ±Ñ Ï°¥Ïû¨)
                MPS->>Vat: ilks(ilk)
                activate Vat
                Vat-->>MPS: (Art, rate, spot, line, dust)
                deactivate Vat

                MPS->>MPS: debt_wad = art √ó rate / RAY
                MPS->>MPS: collateral_value = ink √ó spot / RAY
                MPS->>MPS: health_factor = collateral_value / debt_wad

                alt health_factor < 1.0
                    MPS->>MPS: liquidation_amount = min(debt_wad, max_size)

                    MPS->>PC: calculate_liquidation_profit()
                    activate PC
                    PC->>PC: gross_profit = liquidation_amount √ó 0.13 (13% Î≥¥ÎÑàÏä§)
                    PC->>PC: gas_cost = 800k √ó gas_price
                    PC->>PC: flashloan_fee = debt_amount √ó 0.0009
                    PC->>PC: net_profit = gross_profit - gas_cost - flashloan_fee
                    PC-->>MPS: ProfitabilityAnalysis
                    deactivate PC

                    alt net_profit > min_threshold
                        MPS->>MPS: create_maker_opportunity()
                        Note right of MPS: ÏÑ†ÌÉùÎêú ilk Ï†ÄÏû•<br/>(ETH-A, WBTC-A Îì±)
                    end

                    MPS->>MPS: break // ÏÇ¨Ïö©ÏûêÎãπ 1Í∞ú ilkÎßå
                end
            end
        end
    end

    MPS-->>MPS: opportunities[]
    deactivate MPS
```

### 7Ô∏è‚É£ MakerDAO Ï≤≠ÏÇ∞ Ïã§Ìñâ

```mermaid
sequenceDiagram
    participant LEE as LiquidationExecutionEngine
    participant Vat as MakerDAO Vat
    participant Clipper as MakerDAO Clipper
    participant User as User Vault
    participant DEX as DEX Aggregator
    participant BC as Blockchain

    LEE->>LEE: execute_maker_liquidation(opportunity)
    activate LEE

    LEE->>Clipper: kick(urn, ilk, user, kpr)
    activate Clipper

    Clipper->>Vat: grab(ilk, urn, address(this), address(this), int(art), int(rad))
    activate Vat
    Vat->>User: transfer collateral to clipper
    activate User
    User-->>Vat: collateral transferred
    deactivate User
    Vat-->>Clipper: grab completed
    deactivate Vat

    Clipper-->>LEE: kick successful
    deactivate Clipper

    LEE->>Clipper: take(urn, max_art, max_ink, address(this), calldata)
    activate Clipper

    Clipper->>DEX: swap(collateral, dai, collateral_amount)
    activate DEX
    DEX-->>Clipper: dai_received
    deactivate DEX

    Clipper->>Vat: heal(art)
    activate Vat
    Vat-->>Clipper: heal completed
    deactivate Vat

    Clipper-->>LEE: take successful
    deactivate Clipper

    LEE->>BC: transfer profit to owner
    activate BC
    BC-->>LEE: profit transferred
    deactivate BC

    LEE-->>LEE: update_execution_stats()
    deactivate LEE
```

---

## üì¶ MEV Î≤àÎì§ ÏÉùÏÑ± Î∞è Ï†úÏ∂ú ÌîåÎ°úÏö∞

### 8Ô∏è‚É£ MEV Î≤àÎì§ ÏÉùÏÑ± Í≥ºÏ†ï

```mermaid
sequenceDiagram
    participant LBB as LiquidationBundleBuilder
    participant ABICodec as ABICodec
    participant DEX as DEX Aggregator
    participant Bundle as BundleBuilder
    participant LEE as LiquidationExecutionEngine
    participant FB as FlashbotsClient
    participant Relay as Flashbots Relay

    LBB->>LBB: build_liquidation_bundle(scenario)
    activate LBB

    LBB->>LBB: analyze_competition_level()
    Note right of LBB: Health Factor 0.95 ÎØ∏Îßå<br/>‚Üí Critical Competition

    LBB->>LBB: calculate_success_probability()
    Note right of LBB: base_prob √ó gas_factor √ó slippage_factor

    Note over LBB,Bundle: ÌîåÎûòÏãúÎ°† ÌôúÏÑ±Ìôî Ïãú (Í∂åÏû•)
    LBB->>DEX: get_swap_quote(collateral‚Üídebt)
    activate DEX
    DEX-->>LBB: SwapQuote{to, data, allowanceTarget}
    deactivate DEX

    LBB->>ABICodec: encode_flashloan_receiver_liquidation_params()
    activate ABICodec
    ABICodec-->>LBB: encoded_params
    deactivate ABICodec

    LBB->>ABICodec: encode_aave_flashloan_simple()
    activate ABICodec
    ABICodec-->>LBB: flashloan_calldata
    deactivate ABICodec

    LBB->>Bundle: create_liquidation_bundle(flashloan_tx)
    activate Bundle
    Bundle-->>LBB: Bundle{tx[], max_fee, max_priority_fee}
    deactivate Bundle

    LBB-->>LEE: LiquidationBundle
    deactivate LBB

    LEE->>LEE: execute_liquidation_bundle(bundle)
    activate LEE

    LEE->>LEE: simulate_bundle()
    Note right of LEE: ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏÑ±Í≥µ ÌôïÏù∏

    LEE->>FB: submit_bundle(bundle)
    activate FB

    FB->>Relay: POST /relay/v1/builders
    activate Relay
    Relay-->>FB: bundle_hash
    deactivate Relay

    FB-->>LEE: bundle_hash
    deactivate FB

    loop ÏµúÎåÄ 20Î∏îÎ°ù ÎåÄÍ∏∞ (4Î∂Ñ)
        LEE->>Relay: GET /relay/v1/bundle_status
        activate Relay
        Relay-->>LEE: status (pending/included/rejected)
        deactivate Relay

        alt status == included
            LEE->>LEE: update_execution_stats(success)
            LEE-->>LEE: SubmissionResult{success=true, profit_realized}
        else status == rejected
            LEE-->>LEE: SubmissionResult{success=false, error}
        end
    end

    deactivate LEE
```

---

## üîí ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú vs ÌçºÎ∏îÎ¶≠ Ìè¥Î∞± ÌîåÎ°úÏö∞

### 9Ô∏è‚É£ MEV-lite ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú

```mermaid
sequenceDiagram
    participant OCLS as OnChainLiquidationStrategy
    participant FB as Flashbots
    participant Beaver as BeaverBuild
    participant Titan as TitanBuilder
    participant Mempool as Public Mempool

    OCLS->>OCLS: execute_liquidation_with_mev_lite(opportunity)
    activate OCLS

    OCLS->>OCLS: create_liquidation_transaction()
    OCLS->>OCLS: calculate_dynamic_tip() // ÏòàÏÉÅ ÏàòÏùµÏùò 20%

    Note over OCLS,Titan: ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú ÏãúÎèÑ (Î©ÄÌã∞ Î¶¥Î†àÏù¥)

    OCLS->>FB: try_private_relay("flashbots-protect", tx, tip)
    activate FB
    FB-->>OCLS: PrivateSubmissionResult{success=true/false}
    deactivate FB

    alt Flashbots ÏÑ±Í≥µ
        OCLS-->>OCLS: ‚úÖ ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú ÏÑ±Í≥µ
    else Flashbots Ïã§Ìå®
        OCLS->>Beaver: try_private_relay("beaver-build", tx, tip)
        activate Beaver
        Beaver-->>OCLS: PrivateSubmissionResult{success=true/false}
        deactivate Beaver

        alt BeaverBuild ÏÑ±Í≥µ
            OCLS-->>OCLS: ‚úÖ ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú ÏÑ±Í≥µ
        else BeaverBuild Ïã§Ìå®
            OCLS->>Titan: try_private_relay("titan-builder", tx, tip)
            activate Titan
            Titan-->>OCLS: PrivateSubmissionResult{success=true/false}
            deactivate Titan

            alt TitanBuilder ÏÑ±Í≥µ
                OCLS-->>OCLS: ‚úÖ ÌîÑÎùºÏù¥Îπó Ï†úÏ∂ú ÏÑ±Í≥µ
            else Î™®Îì† Î¶¥Î†àÏù¥ Ïã§Ìå®
                Note over OCLS,Mempool: ÌçºÎ∏îÎ¶≠ Ìè¥Î∞± ÏãúÎèÑ

                OCLS->>OCLS: broadcast_public_liquidation(tx)
                OCLS->>Mempool: eth_sendRawTransaction(signed_tx)
                activate Mempool
                Mempool-->>OCLS: tx_hash
                deactivate Mempool

                OCLS-->>OCLS: ‚ö†Ô∏è ÌçºÎ∏îÎ¶≠ Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏ ÏôÑÎ£å
            end
        end
    end

    deactivate OCLS
```

---

## üí∞ Flashloan Ï≤≠ÏÇ∞ Ïã§Ìñâ ÌîåÎ°úÏö∞

### üîü Aave Flashloan Ï≤≠ÏÇ∞ ÏÉÅÏÑ∏ Í≥ºÏ†ï

```mermaid
sequenceDiagram
    participant LEE as LiquidationExecutionEngine
    participant AavePool as Aave Pool
    participant LiquidationContract as LiquidationStrategy Contract
    participant User as User Account
    participant DEX as DEX Aggregator
    participant Owner as Bot Owner

    LEE->>AavePool: flashLoanSimple(contract, asset, amount, params, 0)
    activate AavePool

    AavePool->>LiquidationContract: executeOperation(asset, amount, premium, initiator, params)
    activate LiquidationContract

    Note over LiquidationContract: 1. Ï≤≠ÏÇ∞ Ïã§Ìñâ
    LiquidationContract->>AavePool: liquidationCall(collateral, debt, user, amount, false)
    activate AavePool
    AavePool->>User: transfer collateral to contract
    activate User
    User-->>AavePool: collateral transferred
    deactivate User
    AavePool-->>LiquidationContract: liquidation successful
    deactivate AavePool

    Note over LiquidationContract: 2. Îã¥Î≥¥ ÌåêÎß§
    LiquidationContract->>DEX: swap(collateral, debt, collateral_amount)
    activate DEX
    DEX-->>LiquidationContract: debt_tokens_received
    deactivate DEX

    Note over LiquidationContract: 3. Flashloan ÏÉÅÌôò
    LiquidationContract->>AavePool: repay(amount + premium)
    AavePool-->>LiquidationContract: repayment successful

    Note over LiquidationContract: 4. ÏàòÏùµ Ï†ÑÏÜ°
    LiquidationContract->>Owner: transfer(profit)
    activate Owner
    Owner-->>LiquidationContract: profit received
    deactivate Owner

    LiquidationContract-->>AavePool: executeOperation completed
    deactivate LiquidationContract

    AavePool-->>LEE: flashloan completed
    deactivate AavePool

    LEE->>LEE: update_execution_stats()
```

---

## üîÑ DEX Aggregator Ïä§Ïôë ÌîåÎ°úÏö∞

### 1Ô∏è‚É£1Ô∏è‚É£ 0x Protocol + 1inch Ìè¥Î∞±

```mermaid
sequenceDiagram
    participant LSV2 as LiquidationStrategyV2
    participant ZeroX as 0x Protocol
    participant OneInch as 1inch
    participant DEX as DEX Router
    participant BC as Blockchain

    LSV2->>LSV2: collect_swap_quotes(user)
    activate LSV2

    Note over LSV2,ZeroX: 0x Protocol Ïö∞ÏÑ† ÏãúÎèÑ
    LSV2->>ZeroX: get_quote(sell_token, buy_token, sell_amount)
    activate ZeroX
    ZeroX->>DEX: find_best_route()
    activate DEX
    DEX-->>ZeroX: optimal_route
    deactivate DEX
    ZeroX-->>LSV2: SwapQuote{to, data, allowanceTarget, price_impact}
    deactivate ZeroX

    alt 0x ÏÑ±Í≥µ
        LSV2->>LSV2: select_best_quote(quotes)
        Note right of LSV2: ÏµúÏÜå Ïä¨Î¶¨ÌîºÏßÄ ÏÑ†ÌÉù
    else 0x Ïã§Ìå®
        Note over LSV2,OneInch: 1inch Ìè¥Î∞± ÏãúÎèÑ
        LSV2->>OneInch: get_quote(sell_token, buy_token, sell_amount)
        activate OneInch
        OneInch->>DEX: find_best_route()
        activate DEX
        DEX-->>OneInch: optimal_route
        deactivate DEX
        OneInch-->>LSV2: SwapQuote{to, data, allowanceTarget, price_impact}
        deactivate OneInch

        LSV2->>LSV2: select_best_quote(quotes)
    end

    LSV2->>BC: execute_swap(quote)
    activate BC
    BC->>DEX: call swap function
    activate DEX
    DEX-->>BC: swap completed
    deactivate DEX
    BC-->>LSV2: swap successful
    deactivate BC

    LSV2-->>LSV2: update_swap_stats()
    deactivate LSV2
```

---

## ‚ö° Í≤ΩÏüÅ Î∂ÑÏÑù Î∞è Í∞ÄÏä§ ÏµúÏ†ÅÌôî ÌîåÎ°úÏö∞

### 1Ô∏è‚É£2Ô∏è‚É£ Ïã§ÏãúÍ∞Ñ Í≤ΩÏüÅ Î∂ÑÏÑù

```mermaid
sequenceDiagram
    participant MempoolWatcher as MempoolWatcher
    participant GasAnalyzer as GasAnalyzer
    participant CompetitionAnalyzer as CompetitionAnalyzer
    participant GasOptimizer as GasOptimizer
    participant LEE as LiquidationExecutionEngine

    MempoolWatcher->>MempoolWatcher: watch_pending_transactions()
    activate MempoolWatcher

    loop Í∞Å ÏÉà Ìä∏ÎûúÏû≠ÏÖò
        MempoolWatcher->>MempoolWatcher: is_liquidation_tx(tx)
        
        alt Ï≤≠ÏÇ∞ Ìä∏ÎûúÏû≠ÏÖò Í∞êÏßÄ
            MempoolWatcher->>GasAnalyzer: analyze_gas_price(tx)
            activate GasAnalyzer
            GasAnalyzer-->>MempoolWatcher: gas_analysis
            deactivate GasAnalyzer

            MempoolWatcher->>CompetitionAnalyzer: analyze_competition(tx)
            activate CompetitionAnalyzer
            CompetitionAnalyzer-->>MempoolWatcher: competition_level
            deactivate CompetitionAnalyzer

            MempoolWatcher->>GasOptimizer: adjust_gas_strategy(analysis)
            activate GasOptimizer
            GasOptimizer->>GasOptimizer: calculate_optimal_gas()
            GasOptimizer-->>MempoolWatcher: optimal_gas_price
            deactivate GasOptimizer

            MempoolWatcher->>LEE: update_gas_strategy(optimal_gas)
            activate LEE
            LEE->>LEE: apply_gas_adjustment()
            deactivate LEE
        end
    end

    deactivate MempoolWatcher
```

### 1Ô∏è‚É£3Ô∏è‚É£ ÎèôÏ†Å Í∞ÄÏä§ Í∞ÄÍ≤© Ï°∞Ï†ï

```mermaid
sequenceDiagram
    participant GasOptimizer as GasOptimizer
    participant BC as Blockchain
    participant TrendAnalyzer as TrendAnalyzer
    participant CompetitionAnalyzer as CompetitionAnalyzer
    participant LEE as LiquidationExecutionEngine

    GasOptimizer->>BC: get_current_gas_price()
    activate BC
    BC-->>GasOptimizer: (base_fee, priority_fee)
    deactivate BC

    GasOptimizer->>TrendAnalyzer: analyze_gas_trends()
    activate TrendAnalyzer
    TrendAnalyzer->>BC: get_historical_gas_prices()
    activate BC
    BC-->>TrendAnalyzer: historical_data
    deactivate BC
    TrendAnalyzer-->>GasOptimizer: trend_analysis
    deactivate TrendAnalyzer

    GasOptimizer->>CompetitionAnalyzer: get_competition_level()
    activate CompetitionAnalyzer
    CompetitionAnalyzer-->>GasOptimizer: competition_score
    deactivate CompetitionAnalyzer

    GasOptimizer->>GasOptimizer: calculate_aggressiveness(urgency, competition)
    Note right of GasOptimizer: urgency √ó 0.6 + competition √ó 0.4

    GasOptimizer->>GasOptimizer: adjust_priority_fee(aggressiveness)
    Note right of GasOptimizer: priority_fee + (1 + aggressiveness) √ó 2 gwei

    GasOptimizer->>GasOptimizer: calculate_max_fee()
    Note right of GasOptimizer: base_fee + priority_fee √ó 2

    GasOptimizer->>LEE: apply_gas_strategy(max_fee, priority_fee)
    activate LEE
    LEE->>LEE: update_transaction_gas()
    deactivate LEE
```

---

## üö® ÏóêÎü¨ Ï≤òÎ¶¨ Î∞è Î≥µÍµ¨ ÌîåÎ°úÏö∞

### 1Ô∏è‚É£4Ô∏è‚É£ Ï≤≠ÏÇ∞ Ïã§Ìñâ Ïã§Ìå® Ï≤òÎ¶¨

```mermaid
sequenceDiagram
    participant LEE as LiquidationExecutionEngine
    participant BC as Blockchain
    participant ErrorHandler as ErrorHandler
    participant RetryManager as RetryManager
    participant FallbackStrategy as FallbackStrategy

    LEE->>LEE: execute_liquidation_bundle(bundle)
    activate LEE

    LEE->>BC: submit_transaction(tx)
    activate BC
    BC-->>LEE: transaction_result
    deactivate BC

    alt Ìä∏ÎûúÏû≠ÏÖò Ïã§Ìå®
        LEE->>ErrorHandler: handle_execution_error(error)
        activate ErrorHandler

        ErrorHandler->>ErrorHandler: classify_error(error)
        Note right of ErrorHandler: Í∞ÄÏä§ Î∂ÄÏ°±, Ïä¨Î¶¨ÌîºÏßÄ Ï¥àÍ≥º,<br/>Í≤ΩÏüÅÏûê ÏÑ†Ï†ê Îì±

        alt Í∞ÄÏä§ Î∂ÄÏ°± ÏóêÎü¨
            ErrorHandler->>RetryManager: retry_with_higher_gas()
            activate RetryManager
            RetryManager->>LEE: retry_with_adjusted_gas()
            deactivate RetryManager
        else Ïä¨Î¶¨ÌîºÏßÄ Ï¥àÍ≥º ÏóêÎü¨
            ErrorHandler->>FallbackStrategy: use_alternative_dex()
            activate FallbackStrategy
            FallbackStrategy->>LEE: retry_with_different_dex()
            deactivate FallbackStrategy
        else Í≤ΩÏüÅÏûê ÏÑ†Ï†ê ÏóêÎü¨
            ErrorHandler->>LEE: skip_opportunity()
            Note right of LEE: Îã§Ïùå Í∏∞ÌöåÎ°ú ÎÑòÏñ¥Í∞ê
        else Í∏∞ÌÉÄ ÏóêÎü¨
            ErrorHandler->>LEE: log_error_and_skip()
        end

        deactivate ErrorHandler
    else Ìä∏ÎûúÏû≠ÏÖò ÏÑ±Í≥µ
        LEE->>LEE: update_success_stats()
    end

    deactivate LEE
```

### 1Ô∏è‚É£5Ô∏è‚É£ DEX Aggregator Ïã§Ìå® Ï≤òÎ¶¨

```mermaid
sequenceDiagram
    participant LSV2 as LiquidationStrategyV2
    participant ZeroX as 0x Protocol
    participant OneInch as 1inch
    participant FallbackDEX as Fallback DEX
    participant ErrorHandler as ErrorHandler

    LSV2->>ZeroX: get_swap_quote()
    activate ZeroX
    ZeroX-->>LSV2: error_response
    deactivate ZeroX

    LSV2->>ErrorHandler: handle_dex_error(error)
    activate ErrorHandler

    ErrorHandler->>ErrorHandler: classify_dex_error(error)
    Note right of ErrorHandler: API ÌÇ§ Ïò§Î•ò, Rate Limit,<br/>ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌÜ†ÌÅ∞ Ïåç Îì±

    alt API ÌÇ§ Ïò§Î•ò
        ErrorHandler->>LSV2: use_fallback_aggregator()
        LSV2->>OneInch: get_swap_quote()
        activate OneInch
        OneInch-->>LSV2: swap_quote
        deactivate OneInch
    else Rate Limit Ïò§Î•ò
        ErrorHandler->>LSV2: wait_and_retry()
        Note right of LSV2: 1Ï¥à ÎåÄÍ∏∞ ÌõÑ Ïû¨ÏãúÎèÑ
    else ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌÜ†ÌÅ∞ Ïåç
        ErrorHandler->>LSV2: use_alternative_route()
        LSV2->>FallbackDEX: find_alternative_route()
        activate FallbackDEX
        FallbackDEX-->>LSV2: alternative_quote
        deactivate FallbackDEX
    else Í∏∞ÌÉÄ Ïò§Î•ò
        ErrorHandler->>LSV2: skip_opportunity()
        Note right of LSV2: Ìï¥Îãπ Í∏∞Ìöå Í±¥ÎÑàÎõ∞Í∏∞
    end

    deactivate ErrorHandler
```

---

## üìä ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ ÌîåÎ°úÏö∞

### 1Ô∏è‚É£6Ô∏è‚É£ Ïã§ÏãúÍ∞Ñ ÏÑ±Îä• Ï∂îÏ†Å

```mermaid
sequenceDiagram
    participant ILM as IntegratedLiquidationManager
    participant MetricsCollector as MetricsCollector
    participant StatsCalculator as StatsCalculator
    participant Dashboard as Dashboard
    participant AlertManager as AlertManager

    ILM->>MetricsCollector: collect_execution_metrics()
    activate MetricsCollector

    MetricsCollector->>MetricsCollector: track_opportunities_detected()
    MetricsCollector->>MetricsCollector: track_bundles_submitted()
    MetricsCollector->>MetricsCollector: track_bundles_included()
    MetricsCollector->>MetricsCollector: track_profit_realized()

    MetricsCollector-->>ILM: raw_metrics
    deactivate MetricsCollector

    ILM->>StatsCalculator: calculate_performance_stats(raw_metrics)
    activate StatsCalculator

    StatsCalculator->>StatsCalculator: calculate_success_rate()
    StatsCalculator->>StatsCalculator: calculate_avg_profit()
    StatsCalculator->>StatsCalculator: calculate_uptime()
    StatsCalculator->>StatsCalculator: calculate_efficiency()

    StatsCalculator-->>ILM: performance_stats
    deactivate StatsCalculator

    ILM->>Dashboard: update_dashboard(performance_stats)
    activate Dashboard
    Dashboard-->>ILM: dashboard_updated
    deactivate Dashboard

    ILM->>AlertManager: check_alert_conditions(performance_stats)
    activate AlertManager

    alt ÏÑ±Í≥µÎ•† < 50%
        AlertManager->>ILM: trigger_alert("Low success rate")
    else ÏàòÏùµ < ÏûÑÍ≥ÑÍ∞í
        AlertManager->>ILM: trigger_alert("Low profitability")
    else ÏãúÏä§ÌÖú Ïò§Î•ò
        AlertManager->>ILM: trigger_alert("System error")
    end

    deactivate AlertManager
    deactivate ILM
```

---

## üéØ Í≤∞Î°†

Ïù¥ Î¨∏ÏÑúÎäî DeFi Ï≤≠ÏÇ∞ Ï†ÑÎûµÏùò Î™®Îì† Ï£ºÏöî ÏãúÎÇòÎ¶¨Ïò§Î•º ÏãúÌÄÄÏä§ Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏúºÎ°ú ÏÉÅÏÑ∏Ìûà ÏÑ§Î™ÖÌï©ÎãàÎã§. Í∞Å Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÄ:

1. **Ïã§Ï†ú Ïª¥Ìè¨ÎÑåÌä∏ Í∞Ñ ÏÉÅÌò∏ÏûëÏö©**ÏùÑ Ï†ïÌôïÌûà Î∞òÏòÅ
2. **Ïô∏Î∂Ä ÏÑúÎπÑÏä§ÏôÄÏùò ÌÜµÏã†**ÏùÑ Ìè¨Ìï®
3. **ÏóêÎü¨ Ï≤òÎ¶¨ Î∞è Î≥µÍµ¨ Î°úÏßÅ**ÏùÑ Î™ÖÏãú
4. **ÏÑ±Îä• ÏµúÏ†ÅÌôî Ï†ÑÎûµ**ÏùÑ ÏãúÍ∞ÅÌôî

Ïù¥Î•º ÌÜµÌï¥ Í∞úÎ∞úÏûêÎäî Ï≤≠ÏÇ∞ ÏãúÏä§ÌÖúÏùò Ï†ÑÏ≤¥Ï†ÅÏù∏ ÌùêÎ¶ÑÏùÑ Ïù¥Ìï¥ÌïòÍ≥†, Í∞Å Îã®Í≥ÑÏóêÏÑú Î∞úÏÉùÌï† Ïàò ÏûàÎäî Î¨∏Ï†úÏ†êÏùÑ ÌååÏïÖÌï† Ïàò ÏûàÏäµÎãàÎã§.

---

**ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏**: 2025-01-06  
**Î¨∏ÏÑú Î≤ÑÏ†Ñ**: v2.2  
**Íµ¨ÌòÑ ÏôÑÏÑ±ÎèÑ**: 98% (Production Ready)