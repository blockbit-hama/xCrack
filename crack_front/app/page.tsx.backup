import { getStatus, defaultStatus, getBundlesSummary, getBundlesRecent, getReport } from "../lib/api";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "../components/ui/card";
import { Badge } from "../components/ui/badge";
import { Progress } from "../components/ui/progress";

export const dynamic = 'force-dynamic';

export default async function Page() {
  const [status, bundles, recent, report] = await Promise.all([
    getStatus().catch(() => defaultStatus()),
    getBundlesSummary().catch(() => ({ stats: { total_created: 0, total_submitted: 0, total_included: 0, total_failed: 0, total_profit: 0, total_gas_spent: 0, avg_submission_time_ms: 0, success_rate: 0 }, submitted_count: 0, pending_count: 0 })),
    getBundlesRecent(5).catch(() => []),
    getReport().catch(() => ({ summary: { transactions_processed: 0, opportunities_found: 0, bundles_submitted: 0, bundles_included: 0, total_profit_eth: '0', success_rate: 0, avg_analysis_time_ms: 0, avg_submission_time_ms: 0 }, recommendations: [] })),
  ]);

  const successRate = status.success_rate * 100;
  const uptimeHours = Math.floor(status.uptime_seconds / 3600);
  const uptimeMinutes = Math.floor((status.uptime_seconds % 3600) / 60);

  return (
    <div className="space-y-6">
      {/* í—¤ë” */}
      <div className="border-b pb-4">
        <h1 className="text-3xl font-bold">xCrack MEV Dashboard</h1>
        <p className="text-gray-600 mt-1">ì‹¤ì‹œê°„ MEV ê¸°íšŒ íƒì§€ ë° ì‹¤í–‰ ì‹œìŠ¤í…œ</p>
      </div>

      {/* ì£¼ìš” ì§€í‘œ ì¹´ë“œ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ì‹œìŠ¤í…œ ìƒíƒœ</CardTitle>
            <div className={`w-3 h-3 rounded-full ${status.is_running ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`}></div>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {status.is_running ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨'}
            </div>
            <p className="text-xs text-muted-foreground">
              í™œì„± ê¸°íšŒ: {status.active_opportunities}ê°œ
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ì´ ìˆ˜ìµ</CardTitle>
            <span className="text-green-600">ğŸ’°</span>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">
              {parseFloat(status.total_profit_eth).toFixed(4)} ETH
            </div>
            <p className="text-xs text-muted-foreground">
              ë²ˆë“¤ ì œì¶œ: {status.submitted_bundles}ê°œ
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ì„±ê³µë¥ </CardTitle>
            <span className="text-blue-600">ğŸ“Š</span>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {successRate.toFixed(1)}%
            </div>
            <Progress value={successRate} className="mt-2" />
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ê°€ë™ ì‹œê°„</CardTitle>
            <span className="text-purple-600">â±ï¸</span>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {uptimeHours}h {uptimeMinutes}m
            </div>
            <p className="text-xs text-muted-foreground">
              {status.uptime_seconds}ì´ˆ
            </p>
          </CardContent>
        </Card>
      </div>

      {/* ë²ˆë“¤ í†µê³„ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">ë²ˆë“¤ ìƒì„±</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{bundles.stats.total_created}</div>
            <p className="text-xs text-muted-foreground">ì´ ìƒì„±ëœ ë²ˆë“¤</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">ë²ˆë“¤ ì œì¶œ</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-blue-600">{bundles.stats.total_submitted}</div>
            <p className="text-xs text-muted-foreground">ì œì¶œëœ ë²ˆë“¤</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">ë²ˆë“¤ í¬í•¨</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{bundles.stats.total_included}</div>
            <p className="text-xs text-muted-foreground">ë¸”ë¡ì— í¬í•¨ëœ ë²ˆë“¤</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-sm font-medium">ë²ˆë“¤ ì‹¤íŒ¨</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{bundles.stats.total_failed}</div>
            <p className="text-xs text-muted-foreground">ì‹¤íŒ¨í•œ ë²ˆë“¤</p>
          </CardContent>
        </Card>
      </div>

      {/* ìµœê·¼ ë²ˆë“¤ */}
      <Card>
        <CardHeader>
          <CardTitle>ìµœê·¼ ë²ˆë“¤ í™œë™</CardTitle>
          <CardDescription>ìµœê·¼ 5ê°œì˜ ë²ˆë“¤ ì‹¤í–‰ ë‚´ì—­</CardDescription>
        </CardHeader>
        <CardContent>
          {recent.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              ìµœê·¼ ë²ˆë“¤ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          ) : (
            <div className="space-y-4">
              {recent.map((bundle) => (
                <div key={bundle.id} className="flex items-center justify-between p-4 border rounded-lg">
                  <div className="flex items-center space-x-4">
                    <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                      <span className="text-white font-bold text-sm">
                        {bundle.strategy.charAt(0).toUpperCase()}
                      </span>
                    </div>
                    <div>
                      <div className="font-medium">#{bundle.id.slice(0, 8)}...</div>
                      <div className="text-sm text-gray-500">{bundle.strategy}</div>
                    </div>
                  </div>
                  <div className="flex items-center space-x-4">
                    <div className="text-right">
                      <div className="font-medium text-green-600">{bundle.expected_profit} ETH</div>
                      <div className="text-sm text-gray-500">{bundle.gas_estimate} gas</div>
                    </div>
                    <Badge variant={bundle.state === 'submitted' ? 'info' : 'warning'}>
                      {bundle.state}
                    </Badge>
                    <div className="text-sm text-gray-500">
                      {new Date(bundle.timestamp).toLocaleString()}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* ì„±ëŠ¥ ì§€í‘œ ë° ê¶Œì¥ì‚¬í•­ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>ì„±ëŠ¥ ì§€í‘œ</CardTitle>
            <CardDescription>ì‹œìŠ¤í…œ ì„±ëŠ¥ ë° ì‘ë‹µ ì‹œê°„</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">í‰ê·  ë¶„ì„ ì‹œê°„</span>
              <span className="text-sm text-gray-600">{report.summary.avg_analysis_time_ms.toFixed(2)} ms</span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">í‰ê·  ì œì¶œ ì‹œê°„</span>
              <span className="text-sm text-gray-600">{report.summary.avg_submission_time_ms.toFixed(2)} ms</span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">ì²˜ë¦¬ëœ íŠ¸ëœì­ì…˜</span>
              <span className="text-sm text-gray-600">{report.summary.transactions_processed.toLocaleString()}</span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">ë°œê²¬ëœ ê¸°íšŒ</span>
              <span className="text-sm text-gray-600">{report.summary.opportunities_found.toLocaleString()}</span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>ì‹œìŠ¤í…œ ê¶Œì¥ì‚¬í•­</CardTitle>
            <CardDescription>ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ê¶Œì¥ì‚¬í•­</CardDescription>
          </CardHeader>
          <CardContent>
            {report.recommendations.length === 0 ? (
              <div className="text-center py-4 text-gray-500">
                í˜„ì¬ ê¶Œì¥ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
              </div>
            ) : (
              <ul className="space-y-2">
                {report.recommendations.slice(0, 5).map((recommendation, index) => (
                  <li key={index} className="flex items-start space-x-2">
                    <span className="text-blue-500 mt-1">â€¢</span>
                    <span className="text-sm">{recommendation}</span>
                  </li>
                ))}
              </ul>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
